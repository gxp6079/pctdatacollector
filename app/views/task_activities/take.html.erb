<div id="file_example_names" data-files="<%=h @files.collect{|f| f.name.split('.').first() + "-#{f.id}"} %>"></div>
<div id="task_progress_id" data-taskprogressid="<%= @task_progress.id %>"></div>
<div id="taskid" data-taskid="<%= @task_progress.task.id %>"></div>
<div id="systemid" data-systemid="<%= @task_progress.task.system_example.id %>"></div>
<div id="userid" data-userid="<%= current_user.id %>"></div>
<div id="timetrackable" data-timetrackable="<%= current_user.is_time_trackable %>"></div>

<div id="content">
  <div class="tv-tabs">
    <label for="tv-tab-1" class="tv-tab">Source Code</label>
    <label for="tv-tab-2" class="tv-tab">Question|Answer</label>
  </div>
</div>


  <% if current_user.has_role? :admin %>
  <div id="console">
    <ul>
      <% @files.each do |file_example| %>
        <li data-time="0" data-field=<%= "data-" + file_example.name.split('.').first() + "-#{file_example.id}" %>>
          <%= file_example.name.split('.').first() %>: <span>0</span>s
        </li>
      <% end %>
    </ul>
  </div>
  <% end %>

  <div id="srcmenu">
    <ul>
      <% @files.each do |file_example| %>
        <li><a class="sourcecode" href=<%= "#" + file_example.name.split('.').first() + "-#{file_example.id}" %> id=<%= file_example.name.split('.').first() + "-#{file_example.id}" %>>
          <%= file_example.name %>
        </a></li>
      <% end %>
      <li><a></a></li>
      <p class="buttons">
        <%= link_to "Task description",
                    {:controller => "task_activities", :action => "system_description",
                    :system => @system_randomly_selected }, {class: "button"}
        %>
      </p>
    </ul>
  </div>

<div id="content">
  <input id="tv-tab-1" name="tv-group" type="radio" class="tv-radio"/>
  <div class="tv-content">
    <% @files.each do |file_example| %>
      <div id=<%= "data-" + file_example.name.split('.').first() + "-#{file_example.id}"%> class="field">
        <pre class="line-numbers"><code class="language-java">
<%= file_example.code %>
        </code></pre>
      </div>
    <% end %>
  </div>
</div>

<div id="content">
  <input id="tv-tab-2" name="tv-group" type="radio" class="tv-radio"/>
  <div class="tv-content">
    <div class="question">
      <h2><%= @task_progress.task.name %></h2>

      <% match = @task_progress.task.description.match(/<#{current_user.group}>(.+)<\\#{current_user.group}>/)
         if match.nil? %>
          <p><%= @task_progress.task.description %></p>
      <% else %>
          <p><%= match[1] %></p>
      <% end %>

      <div id="answermaxrow" data-answermaxrow=3></div>
      <div id="answermaxcol" data-answermaxcol=2></div>
      <table>
        <tr>
          <td><input type="checkbox" id="a1_1" value="true"></td><td>description 1</td>
          <td><input type="checkbox" id="a1_2" value="true"></td><td>description 1</td>
        </tr>
        <tr>
          <td><input type="checkbox" id="a2_1" value="true"></td><td>description 2</td>
          <td><input type="checkbox" id="a2_2" value="true"></td><td>description 2</td>
        </tr>
        <tr>
          <td><input type="checkbox" id="a3_1" value="true"></td><td>description 3</td>
          <td><input type="checkbox" id="a3_2" value="true"></td><td>description 3</td>
        </tr>
      </table>

      <p class="buttons">
         <%= link_to "Finish task", '#', class: "button", :onclick => "doStuff(); return false" %>
      </p>

    </div>
  </div>
</div>

<!--  -->
<script>

$(".field").hide();

$("#tv-tab-2").prop('checked', true);

var taskid = $("#taskid").data("taskid");
var systemid = $("#systemid").data("systemid");
var userid = $("#userid").data("userid");
var timetrackable = $("#timetrackable").data("timetrackable");

var datafields = { fields: []};
var jfiles=$("#file_example_names").data("files");

$.each(jfiles, function(index, value) {
  datafields['fields'].push({selector: '#data-' + value, name: 'data-' + value});
});

$.screentime({
  fields: datafields['fields'],
  reportInterval: 1,
  callback: function(data) {

    $.each(data, function(key, val) {

      if(timetrackable) {
      // Post permanence time
        $.post('/permanence_times', { permanence_time: { task_id: taskid, system_example_id: systemid, user_id: userid, file_example_id: key.replace(/^\w+-\w+-/g, ''), seconds: 1 } } )
      }

      var $elem = $('#console li[data-field="' + key + '"]');
      var current = parseInt($elem.data('time'), 10);

      $elem.data('time', current + val);
      $elem.find('span').html(current += val);
    });
  }
});

$(".sourcecode").click(function() {
  $("#tv-tab-1").prop('checked', true);

  $(".field").hide();
  $(".sourcecode").removeClass("active");
  $("#data-" + this.id).show();
  $(this).addClass("active");
});

function doStuff() {
  var answer = [];
  var task_progress_id = $("#task_progress_id").data("taskprogressid");
  var row = $("#answermaxrow").data("answermaxrow");
  var col = $("#answermaxcol").data("answermaxcol");
  var row_answer;

  for (i = 1; i <= row; i++) {
    row_answer = [];
    for (j = 1; j <= col; j++) {
      row_answer.push($('#a' + i + '_' + j).is(":checked"));
     }
     answer.push(row_answer);
  }

  $.post('/task_activities/finish', { answer: JSON.stringify(answer), task_progress_id: task_progress_id } )

}

</script>
